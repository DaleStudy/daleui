name: NPM Install Test - daleui

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  install-test:
    if: ${{ startsWith(github.head_ref, 'release/') }}
    strategy:
      fail-fast: false # 하나 실패해도 나머지는 계속 돌리게
      matrix:
        include:
          - name: "Create React App (React 18)"
            project: cra
            node: 20

          - name: "Vite + React"
            project: vite
            node: 20

          - name: "Next.js 13 (Pages Router)"
            project: next13-pages
            node: 20

          - name: "Next.js 14 (App Router)"
            project: next14-app
            node: 20

          - name: "Next.js 14 (App Router + Turbopack)"
            project: next14-turbo
            node: 20

    runs-on: ubuntu-latest
    name: ${{ matrix.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: "npm"

      - name: Install dependencies & Build & Pack daleui
        run: |
          npm ci
          npm run build --if-present   # 빌드 스크립트 있으면 실행, 없으면 스킵
          npm pack

      - name: Get .tgz file name
        id: pack
        run: |
          echo "tgz=$(ls daleui-*.tgz)" >> $GITHUB_OUTPUT

      # ========================================
      # 테스트 프로젝트 생성 + daleui 설치 + 빌드
      # ========================================
      - name: Create test project & install daleui
        run: |
          mkdir /tmp/test-project && cd /tmp/test-project

          case "${{ matrix.project }}" in
            cra)
              npx create-react-app@latest . --template typescript --use-npm
              ;;
            vite)
              npm create vite@latest . -- --template react-ts
              ;;
            next13-pages)
              npx create-next-app@13.5.6 . --ts --eslint --no-src-dir --no-tailwind --app=false --import-alias="@/*"
              ;;
            next14-app)
              npx create-next-app@latest . --ts --eslint --tailwind --src-dir --app --import-alias="@/*" --turbopack=false
              ;;
            next14-turbo)
              npx create-next-app@latest . --ts --eslint --tailwind --src-dir --app --import-alias="@/*" --turbo
              ;;
          esac

          # 강제로 로컬 daleui 패키지 설치
          npm install --force ../${{ steps.pack.outputs.tgz }}

      # ========================================
      # 실제로 daleui 써보는 smoke test 페이지 추가
      # ========================================
      - name: Add daleui smoke test
        run: |
          cd /tmp/test-project
          mkdir -p src/smoke
          cat > src/smoke/DaleTest.tsx << 'EOF'
          import React from 'react';
          import { Button } from 'daleui';

          export default function DaleTest() {
            return (
              <div data-testid="daleui-smoke">
                <Button>daleui 성공적으로 로드됨!</Button>
              </div>
            );
          }
          EOF

          # Next.js면 라우팅에 맞게 이동
          if [[ -d "src/app" ]]; then
            mkdir -p src/app/smoke
            mv src/smoke/DaleTest.tsx src/app/smoke/page.tsx
          elif [[ -d "src/pages" ]]; then
            mkdir -p src/pages
            mv src/smoke/DaleTest.tsx src/pages/dale-test.tsx
          else
            mkdir -p src/pages
            mv src/smoke/DaleTest.tsx src/pages/index.tsx
          fi

      # ========================================
      # 최종 빌드 테스트
      # ========================================
      - name: Run production build
        run: |
          cd /tmp/test-project
          npm run build

name: Integration ğŸ”€

on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run format
      - run: bun run lint
      - run: bun run coverage
      - uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - run: bun run build

  install-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Create React App (React 18)"
            project: cra

          - name: "Vite + React"
            project: vite

    runs-on: ubuntu-latest
    name: ${{ matrix.name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies & Build
        run: |
          bun install
          bun run build:lib

      # ========================================
      # í…ŒìŠ¤íŠ¸ í”„ë¡œì íŠ¸ ìƒì„± + daleui ì„¤ì¹˜
      # ========================================
      - name: Create test project & install daleui
        run: |
          mkdir /tmp/test-project && cd /tmp/test-project

          case "${{ matrix.project }}" in
            cra)
              bunx --yes create-react-app@latest . --template typescript
              ;;
            vite)
              bun create vite@5 . --template react-ts
              bun install
              ;;
          esac

          # ë¡œì»¬ daleui íŒ¨í‚¤ì§€ ì„¤ì¹˜
          bun add "$GITHUB_WORKSPACE"

      # ========================================
      # ì‹¤ì œë¡œ daleui ì¨ë³´ëŠ” smoke test í˜ì´ì§€ ì¶”ê°€
      # ========================================
      - name: Add daleui smoke test
        run: |
          cd /tmp/test-project
          mkdir -p src/smoke
          cat > src/smoke/DaleTest.tsx << 'EOF'
          import React from 'react';
          import { Button } from 'daleui';

          export default function DaleTest() {
            return (
              <div data-testid="daleui-smoke">
                <Button>daleui ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë¨!</Button>
              </div>
            );
          }
          EOF

      # ========================================
      # ìµœì¢… ë¹Œë“œ í…ŒìŠ¤íŠ¸
      # ========================================
      - name: Run production build
        run: |
          cd /tmp/test-project
          bun run build
